# reboot

本功能追踪TCP连接中各状态的切换

##  查看帮助信息

通过如下命令查看本功能的帮助信息：
```
diagnose-tools  tcpstates --help
```
结果如下：
```
    tcpstates usage:
        --help tcpstates help info
        --activate
          verbose VERBOSE
          addr filtered ipv4 address.
        --deactivate
        --settings dump settings
        --report dump log with text.
```
##  激活功能

激活本功能的命令是：

```
diagnose-tools tcpstates --activate
```
在激活时可以指定相应参数
verbose为1时可以对当前的tcp连接进行统计输出,addr为某ip地址时可以仅输出当前地址的tcp报文信息
```
diagnose-tools tcpstates --activate="addr=1.1.1.1"
diagnose-tools tcpstates --activate="verbose=1"
```

如果成功，将输出：

功能设置成功，返回值：0
```
    输出级别：1
    过滤地址：0.0.0.0
```
如果失败，将输出：
```
功能设置失败，返回值：-16
    输出级别：1
    过滤地址：0.0.0.0
```

##  查看设置参数

使用如下命令查看本功能的设置参数：
```
diagnose-tools tcpstates --settings
```
结果如下：
```
功能设置：
    是否激活：×
    输出级别：0
```
##  查看结果

执行如下命令查看本功能的输出结果：
`diagnose-tools tcpstates --report`

输出结果示例如下：
未设置verbose（默认为0）

![tcpstates](../../../images/tcpstates1.gif)
```
[1721105348:745988],tcp-states跟踪,源IP: 192.168.239.136,目的IP: 1.1.1.1,源端口: 0,目的端口: 80,原先状态: CLOSE, 新状态: SYN_SENT, 原状态持续时间: 0
        |发送窗口大小: 10,接收窗口大小: 0,发送缓冲区大小: 16384,已使用发送缓冲区大小: 0,接收缓冲区大小: 131072
        |发送字节数: 0,接收字节数: 0,确认字节数: 0,backlog: 0,backlog大小: 0,重传数: 0

[1721105348:906359],tcp-states跟踪,源IP: 192.168.239.136,目的IP: 1.1.1.1,源端口: 37050,目的端口: 80,原先状态: SYN_SENT, 新状态: ESTABLISHED, 原状态持续时间: 160371
        |发送窗口大小: 10,接收窗口大小: 64240,发送缓冲区大小: 16384,已使用发送缓冲区大小: 0,接收缓冲区大小: 131072
        |发送字节数: 0,接收字节数: 0,确认字节数: 1,backlog: 0,backlog大小: 0,重传数: 0

[1721105349:68649],tcp-states跟踪,源IP: 192.168.239.136,目的IP: 1.1.1.1,源端口: 37050,目的端口: 80,原先状态: ESTABLISHED, 新状态: FIN_WAIT1, 原状态持续时间: 162290
        |发送窗口大小: 10,接收窗口大小: 63854,发送缓冲区大小: 87040,已使用发送缓冲区大小: 0,接收缓冲区大小: 131072
        |发送字节数: 71,接收字节数: 386,确认字节数: 72,backlog: 0,backlog大小: 0,重传数: 0

[1721105349:68926],tcp-states跟踪,源IP: 192.168.239.136,目的IP: 1.1.1.1,源端口: 37050,目的端口: 80,原先状态: FIN_WAIT1, 新状态: FIN_WAIT2, 原状态持续时间: 277
        |发送窗口大小: 10,接收窗口大小: 63854,发送缓冲区大小: 87040,已使用发送缓冲区大小: 0,接收缓冲区大小: 131072
        |发送字节数: 71,接收字节数: 386,确认字节数: 73,backlog: 0,backlog大小: 0,重传数: 0

[1721105349:68981],tcp-states跟踪,源IP: 192.168.239.136,目的IP: 1.1.1.1,源端口: 0,目的端口: 80,原先状态: FIN_WAIT2, 新状态: CLOSE, 原状态持续时间: 55
        |发送窗口大小: 10,接收窗口大小: 63854,发送缓冲区大小: 87040,已使用发送缓冲区大小: 0,接收缓冲区大小: 131072
        |发送字节数: 71,接收字节数: 386,确认字节数: 73,backlog: 0,backlog大小: 0,重传数: 0
```
输出结果中包含tcp报文基本四元组信息，在各个阶段的时间，及tcp连接中各信息，如相应窗口大小，收发字节数，backlog及重传等。每次输出结果后，历史数据将被清空。

设置verbose为1时

![tcpstates](../../../images/tcpstates2.gif)
```
[1721105411:165236],tcp-states连接,源IP：192.168.239.136, 目的IP：150.138.153.110, 源端口：42824, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：3482374
[1721105411:165237],tcp-states连接,源IP：192.168.239.136, 目的IP：119.188.176.38, 源端口：41058, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4574116
[1721105411:165237],tcp-states连接,源IP：192.168.239.136, 目的IP：39.91.182.35, 源端口：37692, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3674378
[1721105411:165238],tcp-states连接,源IP：192.168.239.136, 目的IP：163.177.18.92, 源端口：35034, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3467525
[1721105411:165238],tcp-states连接,源IP：192.168.239.136, 目的IP：192.229.211.108, 源端口：57086, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：3401642
[1721105411:165239],tcp-states连接,源IP：192.168.239.136, 目的IP：150.138.153.110, 源端口：42828, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：3480834
[1721105411:165239],tcp-states连接,源IP：192.168.239.136, 目的IP：23.39.160.159, 源端口：33820, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：4739795
[1721105411:165240],tcp-states连接,源IP：192.168.239.136, 目的IP：34.120.208.123, 源端口：53650, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4449323
[1721105411:165240],tcp-states连接,源IP：192.168.239.136, 目的IP：104.193.90.88, 源端口：50724, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3560159
[1721105411:165240],tcp-states连接,源IP：192.168.239.136, 目的IP：34.107.221.82, 源端口：43574, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：5038679
[1721105411:165241],tcp-states连接,源IP：192.168.239.136, 目的IP：34.117.188.166, 源端口：49724, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：5476149
[1721105411:165241],tcp-states连接,源IP：192.168.239.136, 目的IP：23.39.160.159, 源端口：33812, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：4757548
[1721105411:165242],tcp-states连接,源IP：192.168.239.136, 目的IP：153.37.235.134, 源端口：45746, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3738143
[1721105411:165242],tcp-states连接,源IP：192.168.239.136, 目的IP：119.188.176.38, 源端口：41048, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4586592
[1721105411:165243],tcp-states连接,源IP：192.168.239.136, 目的IP：153.37.235.134, 源端口：45754, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3730915
[1721105411:165243],tcp-states连接,源IP：192.168.239.136, 目的IP：153.37.235.134, 源端口：45766, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3733081
[1721105411:165244],tcp-states连接,源IP：192.168.239.136, 目的IP：153.37.235.134, 源端口：45752, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3733596
[1721105411:165244],tcp-states连接,源IP：192.168.239.136, 目的IP：153.37.235.134, 源端口：45750, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3736444
[1721105411:165244],tcp-states连接,源IP：192.168.239.136, 目的IP：34.160.144.191, 源端口：50114, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4759104
[1721105411:165245],tcp-states连接,源IP：192.168.239.136, 目的IP：23.39.160.159, 源端口：0, 目的端口: 80, 状态: SYN_SENT, 状态持续时间：4806943
[1721105411:165245],tcp-states连接,源IP：192.168.239.136, 目的IP：153.37.235.134, 源端口：45742, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4624498
[1721105411:165246],tcp-states连接,源IP：192.168.239.136, 目的IP：118.212.230.35, 源端口：52742, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4386447
[1721105411:165246],tcp-states连接,源IP：192.168.239.136, 目的IP：23.39.160.159, 源端口：33808, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：5027129
[1721105411:165247],tcp-states连接,源IP：192.168.239.136, 目的IP：23.39.160.159, 源端口：0, 目的端口: 80, 状态: SYN_SENT, 状态持续时间：5468901
[1721105411:165247],tcp-states连接,源IP：192.168.239.136, 目的IP：34.107.221.82, 源端口：43568, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：5646724
[1721105411:165248],tcp-states连接,源IP：192.168.239.136, 目的IP：23.39.160.159, 源端口：33796, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：4023868
[1721105411:165248],tcp-states连接,源IP：192.168.239.136, 目的IP：34.149.100.209, 源端口：33226, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4923249
[1721105411:165248],tcp-states连接,源IP：192.168.239.136, 目的IP：34.107.243.93, 源端口：38464, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：4845346
[1721105411:165249],tcp-states连接,源IP：192.168.239.136, 目的IP：124.237.177.59, 源端口：53650, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3422088
[1721105411:165249],tcp-states连接,源IP：192.168.239.136, 目的IP：183.240.238.35, 源端口：49860, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3096088
[1721105411:165250],tcp-states连接,源IP：192.168.239.136, 目的IP：182.61.203.81, 源端口：35710, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3543386
[1721105411:165250],tcp-states连接,源IP：192.168.239.136, 目的IP：104.18.21.226, 源端口：44922, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：4187612
[1721105411:165251],tcp-states连接,源IP：192.168.239.136, 目的IP：150.138.153.110, 源端口：42832, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：3192262
[1721105411:165251],tcp-states连接,源IP：192.168.239.136, 目的IP：104.18.21.226, 源端口：44928, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：4187550
[1721105411:165251],tcp-states连接,源IP：192.168.239.136, 目的IP：104.18.21.226, 源端口：44938, 目的端口: 80, 状态: ESTABLISHED, 状态持续时间：4167964
[1721105411:165252],tcp-states连接,源IP：192.168.239.136, 目的IP：34.107.243.93, 源端口：38466, 目的端口: 443, 状态: ESTABLISHED, 状态持续时间：3828932
------------------------------------------states_num------------------------------------------
---SYN_SENT:2   SYN_RECV:0   ESTABLISHED:34   FIN_WAIT1:0   FIN_WAIT2:0   CLOSE_WAIT:0---
----------------------------------------------------------------------------------------------
```
输出结果中包含目前时刻的tcp连接，其中包括目前所处状态，其持续的实际持续时间，以及相应统计信息



##  关闭功能

通过如下命令关闭本功能：

```
diagnose-tools tcpstates --deactivate
```

关闭功能后，本功能将不会对系统带来性能影响。
