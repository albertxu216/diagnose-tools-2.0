<div align="center"><h1><b><font size=7>Proj208-performance-and-diagnosis-tool</font></b></h1></div>
<div align="center"><font size=3>2024 年全国大学生计算机系统能力大赛操作系统设计赛——功能赛道</font></div>
<div align="center"><font size=3>赛题选择：[proj208-performance-and-diagnosis-tool ](https://github.com/oscomp/proj208-performance-and-diagnosis-tool)</font></div>
<div align="center"><font size=3>队伍名称：这次一定队</font></div>
<div align="center"><font size=3>队员姓名：徐晗博、张铭轩、杨月顺</font></div>
<div align="center"><font size=3>指导教师：陈莉君教授、谢瑞莲老师</font></div>
<div align="center"><font size=3>项目导师：谢宝友（国科础石）</font></div>
<div align="center"><font size=3>学校名称：西安邮电大学</font></div> 

---

[TOC]

## 1.项目简介

**项目名称**：高负载下性能分析与异常诊断工具

**项目描述**：高负载情况下，用户态常用的性能工具常常会失效，这时一个具有高性能、高可靠性 ，同时对系统影响低、准确性强的性能分析和异常诊断工具就显得尤为重要。

## 2.主要工作

- 学习diagnose-tools工具的开发框架并将该工具适配到Linux5.x版本中
- 开发出实用工具来解决目前生产中常见的问题
- 将开发出的各个工具组合起来并解决实际问题
- 搭载高负载环境来测试该工具各方面的性能
- 通过测试结果来对开发的工具进行性能优化
- 将diagnose-tools适配并应用到国产操作系统中


## 3.文档和演示

目前我们已经为diagnose-tools扩展了多个子功能，每一个功能均可以独立解决用户的相关问题，也可以针对特定场景中具体问题将多个功能进行组合，做到`产生问题`——>`发现问题`——>`定位病因`——>`多维度剖析问题`——>`顺利解决问题`。

<img src="images/diagnose-tools.gif">

仓库的目录结构说明如下所示：

```
./
├── 阶段报告.md                                 #阶段报告
├── 决赛报告.md                                 #决赛报告
├── diagnose-tools                              #工具源码
│   ├── deps                                    #工具所需依赖
│   ├── LICENSE
│   ├── Makefile
│   ├── prebuild
│   ├── README.md
│   ├── rpmbuild                                #制作rpm所需的环境
│   ├── SOURCE                                  #工具实现源码
│   │       ├── demo
│   │       ├── diagnose-tools                  #用户态源码
│   │       ├── module                          #内核态源码
│   │       ├── perf-tools
│   │       ├── script
│   │       ├── test
│   │       └── uapi     
│   │                               
│   └── vender
├── docs                                        #说明文档总存放目录
│   ├── 部署开源电商项目fecmall.md
│   ├── 高负载场景下的TCP连接监测方案.md
│   ├── 高负载电商服务器中的问题进程排查.md
│   ├── 工具说明
│   ├── 工具性能分析报告.md
│   ├── 工具性能分析.md
│   ├── 会议记录
│   ├── diagnose工具性能分析
│   ├── images
│   ├── map性能分析.md
│   └── sched_image测试文档.md
├── images                                      #存放文档和项目中涉及的图片
│ 
├── README.md                                   #项目说明文档
└── test                                        #测试文档和测试代码存放的总目录
    ├── 工具性能测试                            
    ├── 正确性验证测试
    └── map性能测试
```

**1.新增工具的详细说明文档：**

| 工具名称       | 功能简介                              | 使用说明                                                     | 工具详细介绍                                                 | 正确性验证                                                   |
| -------------- | ------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| sched-image    | 监控系统中长时间占用CPU的进程相关信息 | [ sched_image使用文档](docs/工具说明/工具使用说明/sched_image.md) | [ sched_image详细介绍文档](docs/工具说明/工具详细介绍/sched_image详细介绍.md) | [sched_image正确性验证](docs/工具说明/工具正确性验证/sched_image_正确性验证.md) |
| keytime-image  | 记录指定进程的关键信息                | [ keytime_image使用文档](docs/工具说明/工具使用说明/keytime-image.md) | [ keytime_image详细介绍文档](docs/工具说明/工具详细介绍/keytime_image详细介绍.md) | [keytime_image正确性验证](docs/工具说明/工具正确性验证/keytime_image_正确性验证.md) |
| migrate-image  | 记录指进程的核间迁移过程              | [ migrate_image使用文档](docs/工具说明/工具使用说明/migrate_image.md) | [ migrate_image详细介绍文档](docs/工具说明/工具详细介绍/migrate_image详细介绍.md) | [ migrate_image正确性验证](docs/工具说明/工具正确性验证/migrate_image_正确性验证.md) |
| resource-image | 记录进程对系统资源实时的使用情况      | [ resource_image使用文档](docs/工具说明/工具使用说明/resource-image.md) | [ resource_image详细介绍文档](docs/工具说明/工具详细介绍/resource_image详细介绍.md) | [ resource_image正确性验证](docs/工具说明/工具正确性验证/resource_image_正确性验证.md) |
| syscall-image  | 监控进程的系统调用信息                | [ syscall_image使用文档](docs/工具说明/工具使用说明/sys-cost.md) | [ syscall_image详细介绍文档](docs/工具说明/工具详细介绍/syscall_image详细介绍.md) | [ syscall_image正确性验证](docs/工具说明/工具正确性验证/syscal_image_正确性验证.md) |
| tcp-states     | 监控并输出系统中TCP连接的具体信息     | [tcpstates使用文档](docs/工具说明/工具使用说明/tcpstates.md) | [tcpstates详细介绍文档](docs/工具说明/工具详细介绍/tcpstates详细介绍.md) | [tcpstates正确性验证](docs/工具说明/工具正确性验证/tcpstates_正确性验证.md) |
| udp-states     | 监控并输出系统中UDP连接具体信息       | [ udp使用文档](docs/工具说明/工具使用说明/udp.md)            | [ udp详细介绍文档](docs/工具说明/工具详细介绍/udp详细介绍.md) | [ udp正确性验证](docs/工具说明/工具正确性验证/udp_正确性验证.md) |

**2.功能组合演示视频**

针对一些高负载场景下的复杂问题或故障，单个独立的小功能是不能做到全维度的问题剖析，这就需要使用diagnose-tools下的多个相关小功能共同合作对问题进行全面检测。但对于用户来说diagnose-tools工具提供的功能繁多，如何组合才能真正的解决其问题是重点，所以我们计划针对不同场景下的若干个复杂问题进行问题剖析示例，就像是给用户提供一整套的组合拳样板，让用户可以快速解决复杂的问题。
目前我们已经针对高负载高并发场景下的两个问题做了组合拳样板，分别解决高负载下由于次要进程长时间占用CPU资源而不被调度下去导致的关键业务抖动、卡顿问题，以及在高负载高并发场景下由于大量的TCP连接导致网络拥堵甚至服务器资源耗尽，从而影响关键业务运行的问题。还有很多复杂问题需要组合多个功能模块去诊断，我们的组合拳摸版也在探索和撰写中。

| 功能名称                           | 说明文档                                             | 演示视频 |
| ---------------------------------- | ---------------------------------------------------- | -------- |
| 高负载高并发下问题进程的多维度剖析 | [进程刨析](docs/高负载电商服务器中的问题进程排查.md) |[高负载高并发场景下问题进程诊断案例演示视频](高负载高并发场景下问题进程诊断案例演示视频.mp4)          |
| 高负载场景下TCP连接监测方案        | [TCP刨析](docs/高负载场景下的TCP连接监测方案.md)     |[高负载场景下的TCP连接监测方案](slowpost恶意攻击监测及诊断.mp4)          |

**3.测试文档：**

| 文档说明                                       | 链接                                              |
| ---------------------------------------------- | ------------------------------------------------- |
| 部署开源电商项目来模拟高负载环境               | [搭建高负载环境](docs/部署开源电商项目fecmall.md) |
| 测试原先工具对系统的性能影响，并提出优化点     | [测试工具性能](docs/工具性能分析.md)              |
| 测试新增工具对系统资源的消耗情况，并提出优化点 | [资源消耗情况](docs/工具性能分析报告.md)          |
| 测试map类型，并对工具的性能进行优化            | [性能优化指导](docs/map性能分析.md)               |

**4.阶段性报告**

| 文档说明 | 链接                              |
| -------- | --------------------------------- |
| 初赛报告 | [初赛报告](阶段报告.md) |
| 决赛报告 | [决赛报告](决赛报告.md)   |

**5.会议记录**

| 日期     | 内容                                                         | 会议记录                                              |
| -------- | ------------------------------------------------------------ | ----------------------------------------------------- |
| 20240327 | 确定选题                                                     | [20240327会议记录](docs/会议记录/20240327会议记录.md) |
| 20240415 | 确定方向和基本路线                                           | [20240415会议记录](docs/会议记录/20240415会议记录.md) |
| 20240425 | 确定开发技术                                                 | [20240425会议记录](docs/会议记录/20240425会议记录.md) |
| 20240505 | 确定模拟真实高负载环境方案                                   | [20240505会议记录](docs/会议记录/20240505会议记录.md) |
| 20240512 | 确定压测方案                                                 | [20240512会议记录](docs/会议记录/20240512会议记录.md) |
| 20240520 | 确定优化方向                                                 | [20240520会议记录](docs/会议记录/20240520会议记录.md) |
| 20240527 | 梳理进度，撰写阶段性技术报告                                 | [20240527会议记录](docs/会议记录/20240527会议记录.md) |
| 20240530 | 为阶段性技术报告做最后准备                                   | [20240530会议记录](docs/会议记录/20240530会议记录.md) |
| 20240601 | 讨论目前的优化点，丰富README                                 | [20240601会议记录](docs/会议记录/20240601会议记录.md) |
| 20240610 | 梳理初赛定的方向，讨论下一阶段是否需要做出修改               | [20240610会议记录](docs/会议记录/20240610会议记录.md) |
| 20240617 | 明确确定决赛阶段的方向，并做任务分配                         | [20240617会议记录](docs/会议记录/20240617会议记录.md) |
| 20240624 | 将diagnose-nose移植到国产操作系统，把功能扩展的目标放在解决真实的问题上 | [20240624会议记录](docs/会议记录/20240624会议记录.md) |
| 20240701 | 性能优化方案制定                                             | [20240701会议记录](docs/会议记录/20240701会议记录.md) |
| 20240710 | 功能测试方案制定                                             | [20240710会议记录](docs/会议记录/20240710会议记录.md) |
| 20270717 | 丰富功能的文档，将eBPF和内核模块进行对比                     | [20240717会议记录](docs/会议记录/20240717会议记录.md) |
| 20240724 | 决赛文档撰写                                                 | [20240724会议记录](docs/会议记录/20240724会议记录.md) |
| 20240725 | 决赛文档任务分配                                             | [20240725会议记录](docs/会议记录/20240725会议记录.md) |
| 20240729 | 修改README 更改仓库框架                                      | [20240729会议记录](docs/会议记录/20240729会议记录.md) |

## 4.项目进展

**赛题要求**：

| 任务编号 | 任务描述                                                     | 完成情况 | 完成细节 |
| -------- | ------------------------------------------------------------ | -------- | -------- |
| 任务1    | 编写性能工具，采集有关数据，输出火焰图 |100%完成|目前diagnose-tools已经开发了28个功能，能采集真实数据并输出火焰图		|
| 任务2    | 能够在高负载下进行压力测试，并可靠地完成性能监测和异常分析   |100%完成|搭建真实高负载场景，模拟本工具在高负载高压环境下对系统进行诊断，可以可靠完成性能监测和异常分析		|
| 任务3    | 在高负载下寻找可优化的部分，要对内核足够熟悉，对性能工具的实现原理足够清楚，有处理高负载情况性能分析的经验，对实际异常、故障比较了解。 |100%完成|对工具在存储方式以及稳定性两个方面进行优化，是工具性能得到显著提升	|

**自主扩展**
| 任务编号 | 任务描述                                                     | 完成情况 | 完成细节 |
| -------- | ------------------------------------------------------------ | -------- | -------- |
| 拓展1    | 开发进程画像系列功能，对进程进行多维度剖析 |100%完成|进程画像系列功能开发完毕，目前可以在高负载环境下找到问题进程，并可以对进程在运行时期的关键行为、资源使用情况、系统调用序列、核间迁移情况进行细粒度的数据抓取与分析|
| 拓展2    | 开发网络相关的系列功能 |100%完成|开发了tcpstates、udp等功能，目前可以在高负载环境下对网络子系统进行细粒度分析|
| 拓展3    | 开发异常时间点确定、负载变化趋势功能|100%完成|对系统进行宏观的数据分析，发现高负载环境下的异常点|
| 拓展5    | 对比内核模块以及eBPF对系统的影响|100%完成|将diagnose-tools中的部分功能通过eBPF实现，并进行了性能对比|
| 拓展4    | 在国产操作系统上移植diagnose-tools，并可以解决该操作系统上的系统故障问题|50%完成|目前已经将diagnose-tools工具完整的移植到龙蜥操作系统上，并能采集其中的数据指标，正在解决该操作系统下的特定系统故障问题|

1.开发的性能诊断工具针对现代计算环境中普遍存在的系统性能监测和诊断难题，特别是在高负载场景下。通过引入内核模块技术，成功解决了传统用户态工具在资源竞争和延迟问题上的不足。该工具实现了对系统中非关键进程的检测和深入分析，能够识别和监控高资源消耗的进程，并提供详尽的CPU调度信息、资源使用情况和网络连接情况。此外，还增加了网络异常检测功能，及时发现潜在的网络威胁和异常流量。通过这些功能的实现，工具大幅提升了系统的可靠性和稳定性，为用户提供了高效、精准的性能监测和问题诊断解决方案。

2.工具进行多维度测试分析以及对存储方式的对比测试，提出了优化点。并且通过修改工具的实现源码，以及工具的开发过程，提升了工具的整体性能。

3.在对整个diagnose-tools进行开发和测试以后，我们重点关注了其在国产龙蜥操作系统上的稳定性和兼容性。经过一系列测试，包括高负载下的性能表现、资源占用情况以及对各种异常情况的处理能力，我们确认该工具在龙蜥操作系统上的表现非常稳定;

目前，我们还需要对所开发的功能进行更深维度的测试，提出更多的优化点并进行更深层次的优化。并且后期需要在工具的可视化和预警方面进行开发，这样可以更方便直观地可以看出系统出现的性能问题。

## 5.项目贡献

1.经汇总diagnose-tools中一共有28个子工具，以下是各个工具的功能描述：

| 工具名称        | 功能描述                                                     |
| --------------- | ------------------------------------------------------------ |
| sched-image     | 监控并输出系统中长时间不被调度的进程相关信息                 |
| keytime-image   | 监控进程的关键信息，例如进程的上下CPU、创建子进程、执行exec等过程 |
| migrate-image   | 监控并输出进程的核间迁移过程中的具体信息                     |
| resource-image  | 监控并输出进程对系统资源实时的使用情况                       |
| tcp-states      | 监控并输出系统中TCP连接的具体信息                            |
| udp-states      | 监控并输出系统中UDP连接具体信息                              |
| 实用小工具pupil | 按照tid查询特定线程在主机上的PID/进程名称/进程链/堆栈等等。**基于此工具，我们又扩充了不同业务进程的画像功能** |
| sys-delay       | 监控syscall长时间运行引起调度不及时。间接引起系统Load高、业务RT高 |
| syscall-image   | 监控进程的系统调用信息，包括系统调用号，系统调用次数，系统调用耗时 |
| irq-delay       | 监控中断被延迟的时间                                         |
| irq-stats       | 统计中断/软中断执行次数及时间                                |
| irq-trace       | 跟踪系统中IRQ/定时器的执行                                   |
| load-monitor    | 监控系统Load值。每10ms查看一下系统当前Load，超过特定值时，输出任务堆栈。这个功能多次在线上抓到重大BUG。**基于此工具，我们又扩充了负载变化趋势图象功能和异常时间点的确定功能** |
| run-trace       | 监控进程在某一段时间段内，在用户态/内核态运行情况            |
| perf            | 对线程/进程进行性能采样，抓取用户态/内核态调用链             |
| kprobe          | 在内核任意函数中，利用kprobe监控其执行，并输出火焰图         |
| uprobe          | 在用户态应用程序中使用探针，在应用中挂接钩子                 |
| exit-monitor    | 监控任务退出。在退出时，打印任务的用户态堆栈信息             |
| mutex-monitor   | 监控长时间持有mutex的流程                                    |
| exec-monitor    | 监控进程调用exec系统调用创建新进程                           |
| alloc-top       | 统计内存分配数量，按序输出内存分配多的进程                   |
| high-order      | 监控分配大内存的调用链                                       |
| reboot          | 监控系统重启信息，打印出调用sys_reboot系统调用的进程名称以及进程链 |
| sched-delay     | 监控系统调度延迟。找到引起调度延迟的进程                     |
| utilization     | 监控系统资源利用率，找到CPU被哪些野进程干扰，以及进程对内存的使用情况 |
| drop-packet     | 监控内核TCP/IP各个流程中的丢包                               |
| tcp-retrans     | 统计内核态一段时间内，各个TCP连接上面的重传计数。            |
| ping-delay      | 追踪ping包的时间延迟。                                       |

每个工具的功能说明和具体的使用方法详见：[工具使用说明](docs/工具说明/工具使用说明)

2.适配龙蜥国产操作系统

在对整个diagnose-tools进行开发和测试以后，我们重点关注了其在龙蜥操作系统上的稳定性和兼容性。经过一系列测试，包括高负载下的性能表现、资源占用情况以及对各种异常情况的处理能力，我们确认该工具在龙蜥操作系统上的表现非常稳定。它能够较准确地检测系统资源的使用情况，及时发现和报告潜在的性能瓶颈和异常现象，同时在操作过程中保持低资源占用，不会对系统的正常运行造成负面影响。这一结果验证了diagnose-tools工具在龙蜥操作系统上的高效性和可靠性，为其在实际生产环境中的广泛应用提供了坚实的基础。
 
## 6 参考与引用
本项目是在谢宝友老师团队的开源工具diagnose-tools的基础上进行性能优化、二次开发与应用；该开源工具地址：[diagnose-tools
](https://github.com/alibaba/diagnose-tools)

本项目在搭建真实高负载环境时，采用了开源电商平台Fecshop项目，该开源系项目地址：[Fecshop](https://github.com/fecshop/yii2_fecshop_docker)
## 7 致谢

感谢团队成员（徐晗博、张铭轩、杨月顺）之间的相互鼓励和相互支持

感谢指导老师（陈莉君教授、谢瑞莲老师）不辞劳苦对本项目的指导

感谢项目老师（谢宝友老师）不辞劳苦对本项目的悉心指点
